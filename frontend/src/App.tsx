import { useState, useCallback, useEffect } from 'react';
import LandingPage from "./components/LandingPage";
import GameBoard from "./components/GameBoard";
import AuthPage from "./components/AuthPage";
import Home from "./components/Home";
import Layout from "./components/ui/Layout";
import * as authApi from "./api/auth";
import { retrieveStoredError } from './api/error';

type View = "auth" | "game-local" | "game-online" | "home" | "landing";

function App() {
	const [view, setView] = useState<View>("landing");
	const [errorMessage, setErrorMessage] = useState<string | null>(null);
	
	useEffect(() => {
		const storedError = retrieveStoredError();

		if (storedError) {
			setErrorMessage(storedError.message);
			// Auto-dismiss after 5 seconds
			setTimeout(() => setErrorMessage(null), 5000);
		}
	}, []);

	useEffect(() => {
		const storedError = localStorage.getItem('auth_error');

		if (storedError) {
			try {
				const errorData = JSON.parse(storedError);
				setErrorMessage(errorData.message);
				localStorage.removeItem('auth_error');
				setTimeout(() => setErrorMessage(null), 5000);
			} catch (e) {
				console.error('Failed to parse auth error:', e);
				localStorage.removeItem('auth_error');
			}
		}
	}, []);

	const goAuth = useCallback(() => setView("auth"), []);
	const goHome = useCallback(() => setView("home"), []);
	const goGameLocal = useCallback(() => setView("game-local"), []);
	const goGameOnline = useCallback(() => setView("game-online"), []);
	const goLanding = useCallback(() => setView("landing"), []);

	const handleLogout = useCallback(async () => {
		await authApi.logout();
		setView("landing");
	}, []);

	return (
		<>
			{view === "landing" && (
				<LandingPage
					onLogin={goAuth}
					onLocal={goGameLocal}
				/>
			)}

			{view === "auth" && (
				<AuthPage
					onBack={goLanding}
					onAuthSuccess={goHome}
				/>
			)}

			{view === "home" && (
				<Home
					onLocal={goGameLocal}
					onOnline={goGameOnline}
					onLogout={handleLogout}
				/>
			)}

			{view === "game-local" && (
				<GameBoard
					mode="local"
					onLeave={goHome}
				/>
			)}

			{view === "game-online" && (
				<GameBoard
					mode="online"
					onLeave={goHome}
				/>
			)}

			{errorMessage && (
				<div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 
                        bg-red-900/90 border border-red-500 text-red-100 
                        px-6 py-3 rounded-lg shadow-lg max-w-md">
					<div className="flex items-center gap-2">
						<svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
							<path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
						</svg>
						<span>{errorMessage}</span>
						<button
							onClick={() => setErrorMessage(null)}
							className="ml-2 text-red-200 hover:text-white"
						>
							âœ•
						</button>
					</div>
				</div>
			)}
		</>
	);
}

export { App }
export default App;
